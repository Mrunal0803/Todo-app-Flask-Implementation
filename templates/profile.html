{% extends 'base.html' %}
{% block title %}Profile{% endblock %}
{% block content %}
<section class="card">
	<h1>Profile</h1>
	<div class="avatar-row">
		<div class="avatar-wrap">
			{% if current_user.avatar_data %}
			<img src="{{ url_for('get_avatar', user_id=current_user.id) }}" alt="Avatar" class="avatar" />
			{% else %}
			<div class="avatar placeholder">{{ current_user.name[0]|upper }}</div>
			{% endif %}
		</div>
		<form method="POST" action="{{ url_for('upload_avatar') }}" enctype="multipart/form-data" class="avatar-form" id="avatar-form">
			<input type="file" name="avatar" id="avatar" accept="image/png,image/jpeg,image/jpg,image/webp" required />
			<div class="form-actions">
				<button class="btn" type="submit">Upload Avatar</button>
			</div>
		</form>
	</div>
	<hr />
		<form method="POST" action="{{ url_for('profile') }}" class="profile-form" id="profile-form" novalidate>
		<input type="hidden" name="intent" value="update_profile" />
		<div class="form-row">
			<label for="name">Name</label>
			<input type="text" id="name" name="name" value="{{ current_user.name }}" required />
		</div>
		<div class="form-row">
			<label for="email">Email</label>
			<input type="email" id="email" name="email" value="{{ current_user.email }}" required />
		</div>
		<div class="form-actions">
			<button class="btn primary" type="submit">Save Profile</button>
		</div>
	</form>
</section>

<section class="card">
	<h2>Change Password</h2>
	<form method="POST" action="{{ url_for('profile') }}" class="profile-form" id="password-form" novalidate>
		<input type="hidden" name="intent" value="change_password" />
		<div class="form-row password-field">
			<label for="current_password">Current Password</label>
			<div class="password-input-wrapper">
				<input type="password" id="current_password" name="current_password" required />
				<button type="button" class="btn password-toggle" data-target="current_password">
					<span class="eye-icon">ğŸ‘ï¸</span>
				</button>
			</div>
		</div>
		<div class="form-row password-field">
			<label for="new_password">New Password</label>
			<div class="password-input-wrapper">
				<input type="password" id="new_password" name="new_password" minlength="6" required />
				<button type="button" class="btn password-toggle" data-target="new_password">
					<span class="eye-icon">ğŸ‘ï¸</span>
				</button>
			</div>
		</div>
		<div class="form-row password-field">
			<label for="confirm_password">Confirm New Password</label>
			<div class="password-input-wrapper">
				<input type="password" id="confirm_password" name="confirm_password" minlength="6" required />
				<button type="button" class="btn password-toggle" data-target="confirm_password">
					<span class="eye-icon">ğŸ‘ï¸</span>
				</button>
			</div>
		</div>
		<div class="form-actions">
			<button class="btn" type="submit">Update Password</button>
		</div>
	</form>
</section>
{% endblock %}
{% block scripts %}
<script>
	document.getElementById('profile-form').addEventListener('submit', function (e) {
		const name = document.getElementById('name').value.trim();
		const email = document.getElementById('email').value.trim();
		if (!name || !email) {
			e.preventDefault();
			alert('Name and Email are required.');
		}
	});
	document.getElementById('password-form').addEventListener('submit', function (e) {
		const c = document.getElementById('current_password').value;
		const n = document.getElementById('new_password').value;
		const cf = document.getElementById('confirm_password').value;
		if (!c || !n || !cf) {
			e.preventDefault();
			alert('Please fill out all password fields.');
			return;
		}
		if (n.length < 6) {
			e.preventDefault();
			alert('New password must be at least 6 characters.');
			return;
		}
		if (n !== cf) {
			e.preventDefault();
			alert('New passwords do not match.');
		}
	});
	// Avatar preview
	const fileInput = document.getElementById('avatar');
	if (fileInput) {
		fileInput.addEventListener('change', function () {
			const f = this.files && this.files[0];
			if (!f) return;
			if (!['image/png','image/jpeg','image/webp'].includes(f.type)) {
				alert('Unsupported image type. Use PNG, JPG, or WEBP.');
				this.value = '';
				return;
			}
			const url = URL.createObjectURL(f);
			let img = document.querySelector('.avatar-wrap img');
			let ph = document.querySelector('.avatar-wrap .placeholder');
			if (!img) {
				img = document.createElement('img');
				img.className = 'avatar';
				document.querySelector('.avatar-wrap').appendChild(img);
				if (ph) ph.remove();
			}
			img.src = url;
		});
	}

	// Password visibility toggles
	document.querySelectorAll('.password-toggle').forEach(button => {
		button.addEventListener('click', function() {
			const targetId = this.dataset.target;
			const input = document.getElementById(targetId);
			if (!input) return;
			const type = input.type === 'password' ? 'text' : 'password';
			input.type = type;
			const icon = this.querySelector('.eye-icon');
			if (icon) icon.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”’';
		});
	});
</script>
{% endblock %}
